/**
 * Export the middleware.
 */

module.exports = geowithin;

var databaseUrl = "mongodb://locuser:locpa$$w0rd@oceanic.mongohq.com:10087/location"
  , collections = ['location', 'market']
  , db = require("mongojs").connect(databaseUrl,collections)

function geowithin(){
	
return function(req,res){	
	market = req.query.market;
	db.market.find({name: market.toUpperCase()}, function(err, data){
		console.log(data.length);
		if (data.length == 0){
			console.log("am i getting here?");
			res.json({"error": err});
			return;
		}
		db.location.find({"loc":{"$geoWithin":{"$geometry":{ type: "Polygon", coordinates: data[0].loc.coordinates }}}}, 
		function(err,data){
			if (err !== null){
				res.json(data);
				return;
			}
			res.json(data);
	});
});
}
}